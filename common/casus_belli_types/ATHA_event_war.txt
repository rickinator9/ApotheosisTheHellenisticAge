##########
# Special 'claim' CB used for Ionian Revolt decision.
# If victorious, the revolt leader gains independence and is given control over all land controlled by their former liege in the Ionia region.
##########

ionian_revolt_cb = {
	group = event

	allowed_for_character = {}

	allowed_against_character = {
		scope:attacker = {
			liege = scope:defender
		}
	}

	target_titles = all
	target_title_tier = duchy
	target_de_jure_regions_above = yes
	ai_only_against_liege = yes

	#Configure war-score. This is a bit different to usual - the roles are effectively reversed, in the sense that the attacker can win entirely through battles (since we don't want the revolt armies heading over to Alexandria or Antioch) whilst the defender has to siege down the rebellious cities.
	defender_capital_gives_war_score = no
	max_attacker_score_from_battles = 100
	max_defender_score_from_battles = 50

	valid_to_start = {
		always = no
	}
	
	cost = {}

	on_declaration = {
		on_declared_war = yes
	}

	on_victory_desc = {
		first_valid = {
			triggered_desc = {
				trigger = { scope:defender = { is_local_player = yes } }
				desc = ionian_revolt_cb_victory_desc_defender
			}
			triggered_desc = {
				trigger = { scope:attacker = { is_local_player = yes } }
				desc = ionian_revolt_cb_victory_desc_attacker
			}
			desc = ionian_revolt_cb_victory_desc
		}	
	}

	on_victory = {
		scope:attacker = { show_pow_release_message_effect = yes }
		
		#Make the revolt leader independent
		if = {
			limit = {
				scope:attacker = { is_independent_ruler = no }
			}
			create_title_and_vassal_change = {
				type = independency
				save_scope_as = going_independent
				add_claim_on_loss = no
			}
			scope:attacker = {
				becomes_independent = {
					change = scope:going_independent
				}
			}
			resolve_title_and_vassal_change = scope:going_independent
		}

		#Attacker gets Ionian kingdom title
		scope:attacker = {
			# Create kingdom title
			create_title_and_vassal_change = {
				type = created
				save_scope_as = change
				add_claim_on_loss = no
			}
			title:k_ionia = {
				change_title_holder = {
					holder = scope:attacker
					change = scope:change
				}
			}
			resolve_title_and_vassal_change = scope:change

			#Rename k_ionia title based on culture
			if = {
				limit = { has_culture = culture:ionian }
				# Rename the title to Ionie
				hidden_effect = {
					title:k_ionia = { set_title_name = cn_ionia_ionic }
				}
			}
			else_if = {
				limit = { has_culture = culture:aeolian }
				# Rename the title to Aiolis
				hidden_effect = {
					title:k_ionia = { set_title_name = d_aiolis }
				}
			}
			else_if = {
				limit = { has_culture = culture:dorian }
				# Rename the title to Doris
				hidden_effect = {
					title:k_ionia = { set_title_name = d_doris }
				}
			}
		}

		#Maintenance event to handle title changes
		scope:defender = {
			trigger_event = anatolia_decisions.0011
			every_vassal_or_below = {
				limit = {
					OR = {
						any_realm_province = { geographical_region = custom_ionia }
						AND = {
							has_character_flag = ionian_revolt_proximity_2
							has_character_flag = ionian_revolt_joined_as_attacker
						}
					}
				}
				trigger_event = anatolia_decisions.0011
			}
		}

		# Truce
		add_truce_attacker_victory_effect = yes

		# FP1: note the victory for future memorialisation via stele (if applicable).
		scope:attacker = { fp1_remember_recent_conquest_victory_effect = yes }

		# Enable decisions to form/liberate kingdoms on the Asian coast
		set_global_variable = {
			name = ionian_revolt_attempted
			value = yes
		}

		# Allow for future Ionian revolts
		remove_list_global_variable = {
			name = unavailable_unique_decisions
			target = flag:ionian_revolt_decision
		}
	}

	on_white_peace_desc = {
		first_valid = {
			triggered_desc = {
				trigger = { scope:defender = { is_local_player = yes } }
				desc = ionian_revolt_cb_white_peace_desc_defender
			}
			triggered_desc = {
				trigger = { scope:attacker = { is_local_player = yes } }
				desc = ionian_revolt_cb_white_peace_desc_attacker
			}
			desc = ionian_revolt_cb_white_peace_desc
		}		
	}

	on_white_peace = {
		scope:attacker = {
			show_pow_release_message_effect = yes
			stress_impact = {
 				ambitious = medium_stress_impact_gain
 				arrogant = medium_stress_impact_gain
 			}
		}
		hidden_effect = {
			scope:attacker = {
				add_truce_both_ways = {
					character = scope:defender
					days = 1825
					war = root.war
					result = white_peace
				}
			}
		}

		scope:defender = {
			add_prestige = minor_prestige_value
			stress_impact = {
 				arrogant = medium_stress_impact_gain
 			}
		}

		# Enable decisions to form/liberate kingdoms on the Asian coast
		set_global_variable = {
			name = ionian_revolt_attempted
			value = yes
		}

		# Allow for future Ionian revolts
		remove_list_global_variable = {
			name = unavailable_unique_decisions
			target = flag:ionian_revolt_decision
		}
	}

	on_defeat_desc = {
		first_valid = {
			triggered_desc = {
				trigger = { scope:defender = { is_local_player = yes } }
				desc = ionian_revolt_cb_defeat_desc_defender
			}
			triggered_desc = {
				trigger = { scope:attacker = { is_local_player = yes } }
				desc = ionian_revolt_cb_defeat_desc_attacker
			}
			desc = ionian_revolt_cb_defeat_desc
		}	
	}

	on_defeat = {
		scope:attacker = { show_pow_release_message_effect = yes }
		scope:defender = {
			add_dread = medium_dread_gain
			# Prestige for Defender
			add_prestige = medium_prestige_value
		}
		
		scope:attacker = {
			hard_imprison_character_effect = {
				TARGET = this
				IMPRISONER = scope:defender
			}
			scope:defender = {
				add_opinion = {
					target = prev
					modifier = vassal_lost_faction_revolt_war
				}
			}
		}

		# Enable decisions to form/liberate kingdoms on the Asian coast
		set_global_variable = {
			name = ionian_revolt_attempted
			value = yes
		}

		# Allow for future Ionian revolts
		remove_list_global_variable = {
			name = unavailable_unique_decisions
			target = flag:ionian_revolt_decision
		}
	}

	on_invalidated_desc = msg_invalidate_war_title

	check_defender_inheritance_validity = no

	on_primary_attacker_death = inherit
	on_primary_defender_death = inherit
	
	attacker_allies_inherit = yes
	defender_allies_inherit = yes

	transfer_behavior = transfer
	
	war_name = "IONIAN_REVOLT_WAR_NAME"
	war_name_base = "IONIAN_REVOLT_WAR_NAME_BASE"
	cb_name = "IONIAN_REVOLT_CB_NAME"

	interface_priority = 120

	attacker_wargoal_percentage = 0.8

	max_attacker_score_from_battles = 100
	max_defender_score_from_battles = 50

	max_ai_diplo_distance_to_title = 500
}