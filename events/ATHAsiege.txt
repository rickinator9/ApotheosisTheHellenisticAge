namespace = ckrpgsiege

scripted_trigger ckrpgsiege_0001_can_be_captured = {
	# Captured characters must be located in the raided barony itself.
	location = scope:barony.title_province

	# Reasons to exclude characters from the capture pool:
	NOR = {
		# If the raiders have defeated the holder's army, but the army has not yet retreated to a different province, shield them from capture by the raid.
		exists = commanding_army
		exists = knight_army

		# Is imprisoned in the barony stay prisoners (special case, any courtiers/vassals of the raider will get released elsewhere).
		is_imprisoned = yes
	}
}

ckrpgsiege.0001 = {
    # Decide what to do with prisoners
    type = character_event
    title = ckrpgsiege.0001.t
	theme = war
    override_background = {
		event_background = burning_building
	}
    hidden = no
    desc = {
        desc = ckrpgsiege.0001.desc
    }
    immediate = {
        save_scope_as = occupant
    	scope:barony.holder = { save_scope_as = holder }
    }
    option = {
        name = ckrpgsiege.0001.a #case by case
        trigger = {

        }
        scope:holder = {
            every_courtier_or_guest = {
                limit = {
                    ckrpgsiege_0001_can_be_captured = yes
                }
                add_to_list = possible_targets
            }
        }
        every_in_list = {
            list = possible_targets
            save_scope_as = victim
            scope:occupant = {
                trigger_event = ckrpgsiege.0002
            }
        }
        ai_chance = {
            base = 100
        }
    }
    option = {
        name = ckrpgsiege.0001.b #imprison all
        trigger = {}
        scope:holder = {
            every_courtier_or_guest = {
                limit = {
                    ckrpgsiege_0001_can_be_captured = yes
                }
                save_scope_as = victim
                scope:occupant = {
                    imprison = {
                        target = scope:victim
                        type = house_arrest
                    }
					stress_impact = {
                        forgiving = minor_stress_impact_gain
                        compassionate = minor_stress_impact_gain
                        vengeful = minor_stress_impact_loss
                        wrathful = minor_stress_impact_loss
                        sadistic = minor_stress_impact_loss
                        callous = minor_stress_impact_loss
                    }
                }
				scope:victim = {
					every_close_family_member = {
						add_opinion = {
							modifier = angry_opinion
							target = scope:occupant
							opinion = -20
						}
					}
					add_opinion = {
						modifier = angry_opinion
						target = scope:occupant
						opinion = -50
					}
				}
            }
			liege = {
				trigger_event = ckrpgsiege.0004
			}
        }
        ai_chance = {
            base = 10
            modifier = {
                add = -10
                has_trait = compassionate
            }
            modifier = {
                add = -10
                has_trait = forgiving
            }
            modifier = {
                add = 10
                has_trait = sadistic
            }
            modifier = {
                add = 10
                has_trait = wrathful
            }
            modifier = {
                add = 10
                has_trait = vengeful
            }
			modifier = {
				add = 10
				has_trait = callous
			}
        }
    }
    option = {
        name = ckrpgsiege.0001.c #kill all
        trigger = {}
        scope:holder = {
            every_courtier_or_guest = {
                limit = {
                    ckrpgsiege_0001_can_be_captured = yes
                }
                save_scope_as = victim
                scope:victim = {
                    death = { killer = scope:occupant death_reason = death_execution }
					every_close_family_member = {
						add_opinion = {
							modifier = angry_opinion
							target = scope:occupant
							opinion = -50
						}
					}
                }
                scope:occupant = {
                    stress_impact = {
                        forgiving = minor_stress_impact_gain
                        compassionate = minor_stress_impact_gain
                        vengeful = minor_stress_impact_loss
                        wrathful = minor_stress_impact_loss
                        sadistic = minor_stress_impact_loss
                        callous = minor_stress_impact_loss
                    }
					# trigger an on on action with 1,000 events?
                }
            }
			liege = {
				trigger_event = ckrpgsiege.0003
			}
        }
        ai_chance = {
            base = 10
            modifier = {
                add = -10
                has_trait = compassionate
            }
            modifier = {
                add = -10
                has_trait = forgiving
            }
            modifier = {
                add = 10
                has_trait = sadistic
            }
            modifier = {
                add = 10
                has_trait = wrathful
            }
            modifier = {
                add = 10
                has_trait = vengeful
            }
			modifier = {
				add = 10
				has_trait = callous
			}
        }
    }
    option = {
        name = ckrpgsiege.0001.d #Release them all
        trigger = {}
        scope:occupant = {
            stress_impact = {
                forgiving = minor_stress_impact_loss
                compassionate = minor_stress_impact_loss
                vengeful = minor_stress_impact_gain
                wrathful = minor_stress_impact_gain
                sadistic = minor_stress_impact_gain
                callous = minor_stress_impact_gain
            }
        }
        ai_chance = {
            base = 10
            modifier = {
                add = 10
                has_trait = compassionate
            }
            modifier = {
                add = 10
                has_trait = forgiving
            }
            modifier = {
                add = -10
                has_trait = sadistic
            }
            modifier = {
                add = -10
                has_trait = wrathful
            }
            modifier = {
                add = -10
                has_trait = vengeful
            }
			modifier = {
				add = -10
				has_trait = callous
			}
        }
    }
}

ckrpgsiege.0002 = {
    type = character_event
    title = ckrpgsiege.0002.t
	theme = war
    override_background = {
		event_background = burning_building
	}
    right_portrait = {
        character = scope:victim
        animation = fear
    }
    hidden = no
    trigger = {

    }
    desc = {
        desc = ckrpgsiege.0002.desc
    }
    immediate = {

    }
    option = {
        name = ckrpgsiege.0002.a
        trigger = {

        }
        scope:occupant = {
            imprison = {
                target = scope:victim
                type = house_arrest
            }
			stress_impact = {
				forgiving = minor_stress_impact_gain
				compassionate = minor_stress_impact_gain
				vengeful = minor_stress_impact_loss
				wrathful = minor_stress_impact_loss
				sadistic = minor_stress_impact_loss
				callous = minor_stress_impact_loss
			}
        }
		scope:victim = {
			stress_impact = {
				base = 50
			}
			every_close_family_member = {
				add_opinion = {
					modifier = angry_opinion
					target = scope:occupant
					opinion = -20
				}
			}
			add_opinion = {
				modifier = angry_opinion
				target = scope:occupant
				opinion = -50
			}
		}
        ai_chance = {
            base = 10
            modifier = {
                add = -10
                has_trait = compassionate
            }
            modifier = {
                add = -10
                has_trait = forgiving
            }
            modifier = {
                add = 10
                has_trait = sadistic
            }
            modifier = {
                add = 10
                has_trait = wrathful
            }
            modifier = {
                add = 10
                has_trait = vengeful
            }
			modifier = {
				add = 10
				has_trait = callous
			}
        }
    }
    option = {
        name = ckrpgsiege.0002.b
        trigger = {

        }
        scope:victim = {
            death = { killer = scope:occupant death_reason = death_execution }
			every_close_family_member = {
				add_opinion = {
					modifier = angry_opinion
					target = scope:occupant
					opinion = -50
				}
			}
        }
        scope:occupant = {
            stress_impact = {
                forgiving = minor_stress_impact_gain
                compassionate = minor_stress_impact_gain
                vengeful = minor_stress_impact_loss
                wrathful = minor_stress_impact_loss
                sadistic = minor_stress_impact_loss
                callous = minor_stress_impact_loss
            }
        }
		ai_chance = {
            base = 10
            modifier = {
                add = -10
                has_trait = compassionate
            }
            modifier = {
                add = -10
                has_trait = forgiving
            }
            modifier = {
                add = 10
                has_trait = sadistic
            }
            modifier = {
                add = 10
                has_trait = wrathful
            }
            modifier = {
                add = 10
                has_trait = vengeful
            }
			modifier = {
				add = 10
				has_trait = callous
			}
        }
    }
    option = {
        name = ckrpgsiege.0002.c #release
        trigger = {}
        scope:occupant = {
            stress_impact = {
                forgiving = minor_stress_impact_loss
                compassionate = minor_stress_impact_loss
                vengeful = minor_stress_impact_gain
                wrathful = minor_stress_impact_gain
                sadistic = minor_stress_impact_gain
                callous = minor_stress_impact_gain
            }
        }
        ai_chance = {
            base = 10
            modifier = {
                add = 10
                has_trait = compassionate
            }
            modifier = {
                add = 10
                has_trait = forgiving
            }
            modifier = {
                add = -10
                has_trait = sadistic
            }
            modifier = {
                add = -10
                has_trait = wrathful
            }
            modifier = {
                add = -10
                has_trait = vengeful
            }
			modifier = {
				add = -10
				has_trait = callous
			}
        }
    }
}

ckrpgsiege.0003 = {
    type = character_event
    title = ckrpgsiege.0003.t
	theme = war
    override_background = {
		event_background = burning_building
	}
    hidden = no
    trigger = {

    }
    desc = {
        desc = ckrpgsiege.0003.desc #Survivors of the siege of [barony.GetName] tell of a great massacre of the nobility.
    }
    immediate = {

    }
	option = {
		name = ckrpgsiege.0003.a #express dismay?
	}
}

ckrpgsiege.0004 = {
    type = character_event
    title = ckrpgsiege.0004.t
	theme = war
    override_background = {
		event_background = burning_building
	}
    hidden = no
    trigger = {

    }
    desc = {
        desc = ckrpgsiege.0004.desc #Survivors of the siege of [barony.GetName] tell how the nobility was led away in chains.
    }
    immediate = {

    }
	option = {
		name = ckrpgsiege.0004.a #express dismay?
	}
}

ckrpgsiege.0005 = {
    type = character_event
    title = ckrpgsiege.0005.t
	theme = war
    override_background = {
		event_background = burning_building
	}
    hidden = no
    trigger = {

    }
    desc = {
        desc = ckrpgsiege.0005.desc #Survivors of the siege of [barony.GetName] tell how the nobility was led away in chains.
    }
    immediate = {

    }
	option = {
		name = ckrpgsiege.0005.a #spare barony
		scope:occupant = {
            stress_impact = {
                forgiving = minor_stress_impact_loss
                compassionate = minor_stress_impact_loss
                vengeful = minor_stress_impact_gain
                wrathful = minor_stress_impact_gain
                sadistic = minor_stress_impact_gain
                callous = minor_stress_impact_gain
            }
        }
		ai_chance = {
            base = 100
            modifier = {
                add = 10
                has_trait = compassionate
            }
            modifier = {
                add = 10
                has_trait = forgiving
            }
            modifier = {
                add = -10
                has_trait = sadistic
            }
            modifier = {
                add = -10
                has_trait = wrathful
            }
            modifier = {
                add = -10
                has_trait = vengeful
            }
			modifier = {
				add = -10
				has_trait = callous
			}
        }
	}
	option = {
		name = ckrpgsiege.0005.b #allow limited looting
		scope:county = {
			change_development_level = -1
			change_county_control = -10
		}
		scope:occupant = {
            stress_impact = {
                forgiving = minor_stress_impact_gain
                compassionate = minor_stress_impact_gain
                vengeful = minor_stress_impact_loss
                wrathful = minor_stress_impact_loss
                sadistic = minor_stress_impact_loss
                callous = minor_stress_impact_loss
            }
        }
		ai_chance = {
            base = 30
            modifier = {
                add = -10
                has_trait = compassionate
            }
            modifier = {
                add = -10
                has_trait = forgiving
            }
            modifier = {
                add = 10
                has_trait = sadistic
            }
            modifier = {
                add = 10
                has_trait = wrathful
            }
            modifier = {
                add = 10
                has_trait = vengeful
            }
			modifier = {
				add = 10
				has_trait = callous
			}
        }
	}
	option = {
		name = ckrpgsiege.0005.c #let army run wild
		scope:county = {
			change_development_level = -2
			change_county_control = -20
		}
		scope:occupant = {
            stress_impact = {
                forgiving = medium_stress_impact_gain
                compassionate = medium_stress_impact_gain
                vengeful = medium_stress_impact_loss
                wrathful = medium_stress_impact_loss
                sadistic = medium_stress_impact_loss
                callous = medium_stress_impact_loss
            }
        }
		ai_chance = {
            base = 10
            modifier = {
                add = -10
                has_trait = compassionate
            }
            modifier = {
                add = -10
                has_trait = forgiving
            }
            modifier = {
                add = 10
                has_trait = sadistic
            }
            modifier = {
                add = 10
                has_trait = wrathful
            }
            modifier = {
                add = 10
                has_trait = vengeful
            }
			modifier = {
				add = 10
				has_trait = callous
			}
        }
	}
	option = {
		name = ckrpgsiege.0005.d #burn everything to the ground
		scope:county = {
			change_development_level = -5
			change_county_control = -50
		}
		scope:occupant = {
            stress_impact = {
                forgiving = major_stress_impact_gain
                compassionate = major_stress_impact_gain
                vengeful = major_stress_impact_loss
                wrathful = major_stress_impact_loss
                sadistic = major_stress_impact_loss
                callous = major_stress_impact_loss
            }
        }
		scope:barony.holder = {
			trigger_event = {
				id = ckrpgsiege.0007
				days = 365
			}
		}
		set_local_variable = {
			name = destruction_year
			value = current_year
		}
		ai_chance = {
            base = 10
            modifier = {
                add = -10
                has_trait = compassionate
            }
            modifier = {
                add = -10
                has_trait = forgiving
            }
            modifier = {
                add = 10
                has_trait = sadistic
            }
            modifier = {
                add = 10
                has_trait = wrathful
            }
            modifier = {
                add = 10
                has_trait = vengeful
            }
			modifier = {
				add = 10
				has_trait = callous
			}
        }
	}
}

ckrpgsiege.0006 = {
    type = character_event
    title = ckrpgsiege.0006.t
	theme = war
    override_background = {
		event_background = burning_building
	}
    hidden = no
    trigger = {

    }
    desc = {
        desc = ckrpgsiege.0006.desc # annual day of rememberance following "Burn Everything Down" siege decision
    }
    immediate = {

    }
	option = {
		name = ckrpgsiege.0006.a #participate
		add_gold = -1
		scope:county = {
			change_county_control = 5
		}
		scope:barony.holder = {
			trigger_event = {
				id = ckrpgsiege.0007
				days = 365
			}
		}
	}
	option = {
		name = ckrpgsiege.0006.b #decline to participate
		scope:county = {
			change_county_control = -5
		}
		scope:barony.holder = {
			trigger_event = {
				id = ckrpgsiege.0007
				days = 365
			}
		}
	}
	option = {
		name = ckrpgsiege.0006.c # put an end to practice
		scope:county = {
			change_county_control = -10
		}
	}
}

ckrpgsiege.0007 = { # handler event to fire remembrance event for current county holder of devastated barony county
    type = character_event
    hidden = yes
    immediate = {

    }
	option = {
		name = OK
	}
	after = {
		scope:barony.holder = {
			trigger_event = ckrpgsiege.0006
		}
	}
}

ckrpgsiege.0008 = { #handler event to avoid triggering prisoner resolution when there are no prisoners
	type = character_event
	hidden = yes
	immediate = {
		save_scope_as = occupant
	}
	option = {
		name = OK
	}
	after = {
		scope:barony.holder = {
			if = {
				limit = {
					any_courtier_or_guest = {
						ckrpgsiege_0001_can_be_captured = yes
					}
				}
				scope:occupant = {
					trigger_event = ckrpgsiege.0001
				}
			}
		}
	}
}
